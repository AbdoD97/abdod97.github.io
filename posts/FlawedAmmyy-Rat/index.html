<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="FlawedAmmyy Rat" /><meta name="author" content="Abdelrahman Eldawi" /><meta property="og:locale" content="en" /><meta name="description" content="FlawedAmmyy is a remote access Trojan (RAT) which is based on leaked Ammyy Admin software. Ammyy Admin is a popular remote access tool used by businesses and consumers to handle remote control and diagnostics on Microsoft Windows machines which makes the FlawedAmmyy RAT to exhibit the functionality of the leaked version, including remote desktop control, file system manager, proxy support and audio chat." /><meta property="og:description" content="FlawedAmmyy is a remote access Trojan (RAT) which is based on leaked Ammyy Admin software. Ammyy Admin is a popular remote access tool used by businesses and consumers to handle remote control and diagnostics on Microsoft Windows machines which makes the FlawedAmmyy RAT to exhibit the functionality of the leaked version, including remote desktop control, file system manager, proxy support and audio chat." /><link rel="canonical" href="https://abdod97.github.io/posts/FlawedAmmyy-Rat/" /><meta property="og:url" content="https://abdod97.github.io/posts/FlawedAmmyy-Rat/" /><meta property="og:site_name" content="Abdelrahman Eldawi" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-10-23T14:33:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="FlawedAmmyy Rat" /><meta name="twitter:site" content="@twitter_usernam" /><meta name="twitter:creator" content="@Abdelrahman Eldawi" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Abdelrahman Eldawi"},"description":"FlawedAmmyy is a remote access Trojan (RAT) which is based on leaked Ammyy Admin software. Ammyy Admin is a popular remote access tool used by businesses and consumers to handle remote control and diagnostics on Microsoft Windows machines which makes the FlawedAmmyy RAT to exhibit the functionality of the leaked version, including remote desktop control, file system manager, proxy support and audio chat.","url":"https://abdod97.github.io/posts/FlawedAmmyy-Rat/","@type":"BlogPosting","headline":"FlawedAmmyy Rat","dateModified":"2021-10-23T15:54:32+02:00","datePublished":"2021-10-23T14:33:00+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://abdod97.github.io/posts/FlawedAmmyy-Rat/"},"@context":"https://schema.org"}</script><title>FlawedAmmyy Rat | Abdelrahman Eldawi</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Abdelrahman Eldawi"><meta name="application-name" content="Abdelrahman Eldawi"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://cdn.jsdelivr.net/gh/cotes2020/chirpy-images/commons/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Abdelrahman Eldawi</a></div><div class="site-subtitle font-italic">Your weekly Reverse Engineering & Malware Analysis blog</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/abdod97" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/twitter_usernam" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['abdelrahman.eldawi97','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>FlawedAmmyy Rat</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>FlawedAmmyy Rat</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Abdelrahman Eldawi </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sat, Oct 23, 2021, 2:33 PM +0200" >Oct 23<i class="unloaded">2021-10-23T14:33:00+02:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sat, Oct 23, 2021, 3:54 PM +0200" >Oct 23<i class="unloaded">2021-10-23T15:54:32+02:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1535 words">8 min read</span></div></div><div class="post-content"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 850 585'%3E%3C/svg%3E" data-proofer-ignore data-src="https://github.com/AbdoD97/abdod97.github.io/blob/master/_posts/mediaFlawwed/media/FlawedAmmyy-RAT.png?raw=true" class="preview-img" alt="Preview Image" width="850" height="585"><p>FlawedAmmyy is a remote access Trojan (RAT) which is based on leaked Ammyy Admin software. Ammyy Admin is a popular remote access tool used by businesses and consumers to handle remote control and diagnostics on Microsoft Windows machines which makes the FlawedAmmyy RAT to exhibit the functionality of the leaked version, including remote desktop control, file system manager, proxy support and audio chat.</p><p>FlawedAmmyy was used in both massive campaigns such as phishing campaigns, to potentially create a large base of compromised computers, as well as targeted campaigns that create opportunities for actors to steal customer data, proprietary information, and more. In the latest campaign of TA505 which is a prolific Cybercriminal group known for attacks against multiple financial institutions and retail companies, they started using HTML attachments to deliver malicious .XLS files that lead to downloader and backdoor FlawedAmmyy, mostly to target South Korean users.</p><p><strong>Sample Information</strong></p><p>SHA256:CB114123CA1C33071CF6241C3E5054A39B6F735D374491DA0B33DFDAA1F7EA22</p><p>MD5:B635C11EFDF4DC2119FA002F73A9DF7B</p><p>Sample Type Windows Exe (x86-32)</p><p><strong>Executive Summary</strong></p><p>This malware is just a downloader for the actual encrypted malware to evade detection, it decrypts then executes it, also it enforces some persistence techniques according to the running environment to make sure that the malware would still be there in victim’s machine</p><h1 id="initial-assessment">Initial assessment</h1><p>At Malware initial assessment using <strong>Pestudio</strong> and <strong>DIE (Detect it easy),</strong> it was found that the sample is <strong>Windows Exe (x86-32)</strong> and it has <strong>(Microsoft Visual C/C++(6.0))</strong> compiler stamp</p><p><img data-proofer-ignore data-src="https://github.com/AbdoD97/abdod97.github.io/blob/master/_posts/mediaFlawwed/media/image1.png?raw=true" alt="" /></p><p>By analyzing the entropy of file sections, it looks like there is appended part on the exe (<strong>Overlay)</strong> that is packed and indirectly loaded after the malware is executed</p><p><img data-proofer-ignore data-src="https://github.com/AbdoD97/abdod97.github.io/blob/master/_posts/mediaFlawwed/media/image2.png?raw=true" alt="" /></p><h2 id="unpacking">Unpacking</h2><p>To unpack the file, I used <strong>Unpac.me</strong> online service and it was able to extract the unpacked child</p><p><img data-proofer-ignore data-src="https://github.com/AbdoD97/abdod97.github.io/blob/master/_posts/mediaFlawwed/media/image3.png?raw=true" alt="" /></p><p><strong>Unpacked Sample basic information</strong></p><p>MD5 :71b183a44f755ca170fc2e29b05b64d5</p><p>SHA1: 67fc3717e0ea134599633e1e7e8daf6cc0857f99</p><h2 id="imports">Imports</h2><p><img data-proofer-ignore data-src="https://github.com/AbdoD97/abdod97.github.io/blob/master/_posts/mediaFlawwed/media/image4.png?raw=true" alt="" /></p><p>We can find lots of interesting API calls which is able to <strong>manipulate Registry</strong>, <strong>Files</strong> &amp; <strong>Execute processes … etc</strong></p><h2 id="strings">Strings</h2><p>If we examine the strings of malware, we can identify a lot of malicious strings that give us information about the behavior of the malware and what it tries to do on a system.</p><p><img data-proofer-ignore data-src="https://github.com/AbdoD97/abdod97.github.io/blob/master/_posts/mediaFlawwed/media/image5.png?raw=true" alt="" /></p><p><img data-proofer-ignore data-src="https://github.com/AbdoD97/abdod97.github.io/blob/master/_posts/mediaFlawwed/media/image6.png?raw=true" alt="" /></p><p>These strings are combination of CMD commands, URL, System Paths, Files.</p><p>Cmd commands are used to query domain controller and manipulate windows services.</p><p>URL is for a file to be downloaded apparently</p><p>And some interested paths and files</p><h1 id="dynamic-analysis-using-sandbox">Dynamic analysis using sandbox</h1><p>Using <strong>any.run</strong> service it was found that the malware is querying the domain controller for the machine, then it deletes itself.</p><p><img data-proofer-ignore data-src="https://github.com/AbdoD97/abdod97.github.io/blob/master/_posts/mediaFlawwed/media/image7.png?raw=true" alt="" /></p><p>Looking at HTTP requests, it tried to download a file but the server didn’t respond, so this clarifies why it deleted itself from the system at the first place</p><p><img data-proofer-ignore data-src="https://github.com/AbdoD97/abdod97.github.io/blob/master/_posts/mediaFlawwed/media/image8.png?raw=true" alt="" /></p><h1 id="analysis-part">Analysis part</h1><p>*All functions were renamed by me to easy explanations</p><p><img data-proofer-ignore data-src="https://github.com/AbdoD97/abdod97.github.io/blob/master/_posts/mediaFlawwed/media/image9.png?raw=true" alt="" /> The first variable v18 is calling a function to get the Major &amp; Minor version of the windows in order to identify the windows version</p><p>The next 2 functions (<strong>EraseTape</strong> which is used to erase Tape storage, <strong>GetPrinterA</strong> retrieves information about a specified printer), They were put there for no reason cause 0 is passed in handle argument which is invalid handle for Tape or Printer. So, we can say that they were put as a distraction.</p><p>Then the if condition (<strong>sub_411260</strong>) it executes (<strong>net group /domain</strong>)* to check the domain name you are inside and check whether it’s WORKGROUP and returns true if it is, but this if condition is <strong>always</strong> <strong>TRUE</strong> because the OR condition with both return and the compliment, one of them will be TRUE</p><p>*<a href="https://attack.mitre.org/techniques/T1087/">https://attack.mitre.org/techniques/T1087/</a></p><h2 id="delete_wsus_exe-function">Delete_wsus_exe function</h2><p><img data-proofer-ignore data-src="https://github.com/AbdoD97/abdod97.github.io/blob/master/_posts/mediaFlawwed/media/image10.png?raw=true" alt="" /></p><p>At first it executes (<strong>SHGetSpecialFolderPathA</strong>) it retrieves the path of a special folder, identified by its CSIDL, 0x23 CSIDL refers to <strong>CSIDL_COMMON_APPDATA</strong> which is the file system directory containing application data for all users. Aka (<strong>C:\ProgramData</strong>) it appends it then to both paths shown on image above</p><p>And then delete the wsus.exe file, this behavior is associated with removing previous versions or instances of the malware if it was already running.</p><p><strong>Check_If_Admin function: -</strong></p><p><strong>This function wasn’t called directly, But it was dynamically resolved and this how it looked like</strong></p><p><img data-proofer-ignore data-src="https://github.com/AbdoD97/abdod97.github.io/blob/master/_posts/mediaFlawwed/media/image11.png?raw=true" alt="" /></p><p><strong>After tracing inside this function</strong></p><p><img data-proofer-ignore data-src="https://github.com/AbdoD97/abdod97.github.io/blob/master/_posts/mediaFlawwed/media/image12.png?raw=true" alt="" /></p><p>By setting a breakpoint on the return of the <strong>(sub_401540)</strong> and checking the return value we can find that</p><p><img data-proofer-ignore data-src="https://github.com/AbdoD97/abdod97.github.io/blob/master/_posts/mediaFlawwed/media/image13.png?raw=true" alt="" /></p><p>It loaded Shell32_IsUserAnAdmin</p><p>Then it checks whether the malware was executed with an admin privilege</p><h2 id="terminate-process-function">Terminate process function</h2><p><img data-proofer-ignore data-src="https://github.com/AbdoD97/abdod97.github.io/blob/master/_posts/mediaFlawwed/media/image14.png?raw=true" alt="" /></p><p>As it appears it takes a snapshot of processes already running and loop on them till it find “wsus.exe”, If so, it would terminate it</p><p>The three subroutines were resolved using the same method explained before</p><p>Then it tries to delete it once more</p><h2 id="exec_cmd-function">exec_cmd function</h2><p><a href="https://attack.mitre.org/techniques/T1059/003/">https://attack.mitre.org/techniques/T1059/003/</a></p><p>This function executes a CMD commands and this one was resolved for <strong>shell32_ShellExecuteW</strong> and by running this as CMD command “<strong>net.exe stop foundation</strong>” it stops “<strong>foundation”</strong> service and then it deletes it using “<strong>sc delete foundation</strong>”</p><p>Once more it terminates “wsus.exe” if it’s running.</p><p>It creates then “<strong>C:\ProgramData\Nugets</strong>”</p><p>Then it resolves the “<strong>user32_wsprintfA”</strong> by loading the library first then the function and setting it to a pointer variable.</p><p>Then it uses <strong>CoCreateGuid</strong> to create a unique identifier for the victim</p><p>Then it deletes the file <strong>“C:\</strong> <strong>ProgramData\Nuggets\template_??.TMPTMPZIP7”</strong> for the purpose of old instances cleaning</p><blockquote><p>?? refers to the (guid.Part3 + guid.Part1 * guid.Part2)</p></blockquote><p>Let’s continue with the code</p><p><img data-proofer-ignore data-src="https://github.com/AbdoD97/abdod97.github.io/blob/master/_posts/mediaFlawwed/media/image15.png?raw=true" alt="" /></p><p>As we can see <strong>file_downloader_write</strong> is called and it’s the function responsible for downloading the malware, The reference passed to this function as <strong>highlighted is the reference for the URL</strong> <a href="http://54.38.127.28/02.dat"><strong>http://54.38.127.28/02.dat</strong></a></p><h2 id="file_downloader_write">file_downloader_write</h2><p><img data-proofer-ignore data-src="https://github.com/AbdoD97/abdod97.github.io/blob/master/_posts/mediaFlawwed/media/image16.png?raw=true" alt="" /></p><p><img data-proofer-ignore data-src="https://github.com/AbdoD97/abdod97.github.io/blob/master/_posts/mediaFlawwed/media/image17.png?raw=true" alt="" /></p><p>It loads the lib “<strong>wininet.dll</strong>” then “<strong>InternetReadFile , InternetOpenA, InternetOpenUrlA”</strong> functions were resolved also to visit <strong><a href="http://54.38.127.28/02.dat">http://54.38.127.28/02.dat</a> and download it to “C:\</strong> <strong>ProgramData\Nuggets\template_??.TMPTMPZIP7”</strong></p><p>I looked at <strong>Shodan</strong> to check whether there is any information about this IP address but it seems negative</p><p>So, at this time I needed to emulate the download server, instead of using FakeNet I have setup a <strong>loopback adapter</strong> to redirect that specific IP to localhost and configured it’s Ip to <strong>54.38.127.28</strong>, Then I used Python <strong>SimpleHTTPServer</strong> to serve the file.</p><div class="language-python highlighter-rouge"><div class="code-header" data-lang="python"><button><i class="fa-fw far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">SimpleHTTPServer</span> <span class="mi">80</span>
</pre></table></code></div></div><p><img data-proofer-ignore data-src="https://github.com/AbdoD97/abdod97.github.io/blob/master/_posts/mediaFlawwed/media/image18.png?raw=true" alt="" /></p><p>Then the file was opened and handle was passed to “<strong>hfile</strong>”</p><p>Then it reads the file content and pass a point to “<strong>lpbuffer</strong>”</p><p>It then checks if the file size is more than <strong>4Kb</strong> , is so delete the existed “<strong>wsus.exe</strong>”</p><h2 id="decrypt_file-function">Decrypt_File function</h2><p>The file downloaded was encrypted to be able to evade antiviruses catching it in the way, So it decrypts it in house to be able to use it</p><p>The decryption key used in the function is “Porow2uj548423”</p><p><img data-proofer-ignore data-src="https://github.com/AbdoD97/abdod97.github.io/blob/master/_posts/mediaFlawwed/media/image19.png?raw=true" alt="" /></p><h3 id="create-the-decoding-array-function">Create the decoding array function</h3><p><img data-proofer-ignore data-src="https://github.com/AbdoD97/abdod97.github.io/blob/master/_posts/mediaFlawwed/media/image20.png?raw=true" alt="" /></p><p>Then how is this working?</p><p>At first it creates an array of length <strong>256</strong> and initiate it with numbers from [<strong>0&gt;255</strong>] in sequence</p><p>a[0] = 0 , a[1] = 1 …… therefore <strong>a[j] = j</strong> until it loops 256 times</p><div class="language-c highlighter-rouge"><div class="code-header" data-lang="c"><button><i class="fa-fw far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">v7</span> <span class="o">+=</span> <span class="n">j</span> <span class="o">+</span> <span class="n">dec_key</span><span class="p">[</span><span class="n">v8</span><span class="p">]</span> 
<span class="n">v6</span> <span class="o">=</span><span class="n">j</span>
<span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">v7</span><span class="p">]</span>
<span class="n">a</span><span class="p">[</span><span class="n">v7</span><span class="p">]</span><span class="o">=</span><span class="n">v6</span><span class="o">=</span><span class="n">j</span> <span class="n">therefore</span> <span class="n">a</span><span class="p">[</span><span class="n">v7</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span>
</pre></table></code></div></div><p>The variable <strong>v8</strong> keeps increasing till it reaches the (<strong>secret key</strong>) length then it’s set to 0 again, after it ends, the decoding matrix constructed from the word should be like the illustration below</p><p><img data-proofer-ignore data-src="https://github.com/AbdoD97/abdod97.github.io/blob/master/_posts/mediaFlawwed/media/image21.png?raw=true" alt="" /></p><h3 id="decryption-function">Decryption function</h3><p>As we can see the length of this array is 256 so in the second function which makes the actual decryption extends the usage &amp; edits it to the file length to fit, so the current 2 factors affecting the actual encryption XOR key is <strong>Downloaded file length</strong> &amp; <strong>the initial word passed into the first function</strong></p><p><strong>Sub_4126E0</strong></p><p><img data-proofer-ignore data-src="https://github.com/AbdoD97/abdod97.github.io/blob/master/_posts/mediaFlawwed/media/image22.png?raw=true" alt="" /></p><p><strong>v5, v6 , v7 are int8 so their max num is 256 then it overflows and start from beginning</strong></p><p>At first variable <strong>v6, v7</strong> are initiated with value <strong>0,</strong> the decryption algorithm loop till it reaches the end of the downloaded file, noting that variable <strong>v7</strong> is increased by one every iteration, simplified pseudo code is shown downside for more illustration</p><div class="language-c highlighter-rouge"><div class="code-header" data-lang="c"><button><i class="fa-fw far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">V6</span><span class="o">+=</span> <span class="n">decoding_arr</span><span class="p">[</span><span class="n">v7</span><span class="p">]</span>
<span class="n">V5</span> <span class="o">=</span> <span class="n">decoding_arr</span><span class="p">[</span><span class="n">v7</span><span class="p">]</span>
<span class="n">decoding_arr</span><span class="p">[</span><span class="n">v7</span><span class="p">]</span> <span class="o">=</span> <span class="n">decoding_arr</span><span class="p">[</span><span class="n">v6</span><span class="p">]</span>
<span class="n">decoding_arr</span><span class="p">[</span><span class="n">v6</span><span class="p">]</span> <span class="o">=</span> <span class="n">v5</span> <span class="o">=</span> <span class="n">decoding_arr</span><span class="p">[</span><span class="n">v7</span><span class="p">]</span>
<span class="n">EncryptedFile</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="n">Xor</span> <span class="n">decoding_arr</span><span class="p">[</span><span class="n">decoding_arr</span><span class="p">[</span><span class="n">v6</span><span class="p">]</span><span class="o">+</span><span class="n">decoding_array</span><span class="p">[</span><span class="n">v7</span><span class="p">]]</span>
</pre></table></code></div></div><h2 id="returning-back-to-main-function-analysis">Returning back to main function analysis</h2><p><img data-proofer-ignore data-src="https://github.com/AbdoD97/abdod97.github.io/blob/master/_posts/mediaFlawwed/media/image23.png?raw=true" alt="" /></p><p>Then it checks whether the decryption was done correctly or not by checking the magic bytes “<strong>MZ</strong>” on the decrypted file buffer then checks for admin privileges</p><p>if <strong>it’s not admin</strong></p><ul><li><p>it will open the file “<strong>wsus.exe</strong>” and then delete <strong>“C:\</strong> <strong>ProgramData\Nuggets\template_??.TMPTMPZIP7”</strong> file</p><li><p><strong>Then</strong> deletes the file which is executing</p></ul><p>If it has admin privilege then it will continue to the next function.</p><h2 id="persistence-function">Persistence function</h2><p><img data-proofer-ignore data-src="https://github.com/AbdoD97/abdod97.github.io/blob/master/_posts/mediaFlawwed/media/image24.png?raw=true" alt="" /></p><p><img data-proofer-ignore data-src="https://github.com/AbdoD97/abdod97.github.io/blob/master/_posts/mediaFlawwed/media/image25.png?raw=true" alt="" /></p><p>At first it resolves “<strong>SHGetSpecialFolderPathW</strong>” api using its ordinal number <strong>175.</strong></p><ul><li>If the process was opened by <strong>admin privileges</strong>, then it will use <strong>service persistence technique</strong></ul><p>constructs the previous “<strong>wsus.exe</strong>” path like before. And it stops and deletes “<strong>foundation</strong>” service, and then it creates a service with the same name and configure it to be started automatically when widows start</p><p><a href="https://attack.mitre.org/techniques/T1543/003/">https://attack.mitre.org/techniques/T1543/003/</a></p><ul><li>If the process doesn’t have that privilege, then it will <strong>add wsus.exe to auto startup registry</strong></ul><blockquote><p>Create a registry value in “<strong>HKCU\Software\Microsoft\windows\CurrentVersion\Run</strong>” which makes the files auto executed on the startup</p></blockquote><p>The entry name will be IntelProtected</p><p><a href="https://attack.mitre.org/techniques/T1547/001/">https://attack.mitre.org/techniques/T1547/001/</a></p><p>Then the running file is deleting itself and it ends :)</p><h1 id="indicator-of-compromises">Indicator of compromises</h1><h2 id="hashes"><strong>Hashes</strong></h2><ol><li><p>Sample2.exe<br /> MD5:B635C11EFDF4DC2119FA002F73A9DF7B<br /> SHA1:C35A4DF038B20B9DC3FF14116325B2E36B722F6C</p><li><p>Sample2_unpacked.exe</p><p>MD5:71B183A44F755CA170FC2E29B05B64D5</p><p>SHA1:67FC3717E0EA134599633E1E7E8DAF6CC0857F99</p></ol><h2 id="files"><strong>Files</strong></h2><ol><li><p>C:\ ProgramData\Nuggets\template_??.TMPTMPZIP7</p><li><p>C:\ ProgramData\Nuggets\wsus.exe</p><blockquote><p>?? refers to the (guid.Part3 + guid.Part1 * guid.Part2)</p></blockquote></ol><h2 id="url"><strong>URL</strong></h2><ol><li><a href="http://54.38.127.28/02.dat">http://54.38.127.28/02.dat</a></ol><h2 id="startup-registry"><strong>Startup Registry</strong></h2><ol><li><strong>Path</strong> : HKCU\Software\Microsoft\windows\CurrentVersion\Run\</ol><p><strong>Name</strong> : IntelProtected</p><p><strong>Value</strong> : C:\ProgramData\wsus.exe</p><h2 id="services"><strong>Services</strong></h2><ol><li><strong>Foundation</strong> service, <strong>auto executes</strong> this file on startup C:\ProgramData\NuGets\wsus.exe</ol></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/malware-reports/'>malware-reports</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/malware-unpacking/" class="post-tag no-text-decoration" >malware-unpacking</a> <a href="/tags/unpacking/" class="post-tag no-text-decoration" >unpacking</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=FlawedAmmyy Rat - Abdelrahman Eldawi&url=https://abdod97.github.io/posts/FlawedAmmyy-Rat/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=FlawedAmmyy Rat - Abdelrahman Eldawi&u=https://abdod97.github.io/posts/FlawedAmmyy-Rat/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=FlawedAmmyy Rat - Abdelrahman Eldawi&url=https://abdod97.github.io/posts/FlawedAmmyy-Rat/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink('', 'Link copied successfully!')" data-toggle="tooltip" data-placement="top" title="Copy link"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/FlawedAmmyy-Rat/">FlawedAmmyy Rat</a><li><a href="/posts/PoetRAT-Report/">PoetRAT</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/malware-unpacking/">malware-unpacking</a> <a class="post-tag" href="/tags/unpacking/">unpacking</a> <a class="post-tag" href="/tags/dropper/">dropper</a> <a class="post-tag" href="/tags/macro/">macro</a> <a class="post-tag" href="/tags/obfuscated-macro/">obfuscated-macro</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/rat/">rat</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Remcos-Malware-Unpacking/"><div class="card-body"> <span class="timeago small" >Sep 21<i class="unloaded">2021-09-21T05:33:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Remcos Malware Unpacking</h3><div class="text-muted small"><p> Remcos or Remote Control and Surveillance, marketed as a legitimate software by a Germany-based firm Breaking Security for remotely managing Windows systems is now widely used in multiple malicious...</p></div></div></a></div><div class="card"> <a href="/posts/PoetRAT-Report/"><div class="card-body"> <span class="timeago small" >Sep 25<i class="unloaded">2021-09-25T18:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>PoetRAT</h3><div class="text-muted small"><p> Python RAT uses COVID-19 document lures to target Azerbaijan public and private sectors. Azerbaijan government and energy sector likely targeted by an unknown actor. From the energy sector, the a...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/PoetRAT-Report/" class="btn btn-outline-primary" prompt="Older"><p>PoetRAT</p></a> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="">abdelrahman eldawi</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/malware-unpacking/">malware unpacking</a> <a class="post-tag" href="/tags/unpacking/">unpacking</a> <a class="post-tag" href="/tags/dropper/">dropper</a> <a class="post-tag" href="/tags/macro/">macro</a> <a class="post-tag" href="/tags/obfuscated-macro/">obfuscated macro</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/rat/">rat</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { let initTheme = "default"; if ($("html[mode=dark]").length > 0 || ($("html[mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://abdod97.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
